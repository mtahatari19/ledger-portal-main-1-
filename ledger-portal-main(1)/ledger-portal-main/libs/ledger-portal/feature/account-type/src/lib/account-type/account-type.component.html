<div class="min-h-screen p-6">
  <!-- Header Section -->
  <div class="mb-8">
    <ledger-portal-shared-ui-breadcrumb />
  </div>

  <!-- Main Content -->
  <div class="mx-auto max-w-6xl">

    <!-- Form Content -->
    <div class="p-6">
      <mat-progress-bar
        mode="determinate"
        [value]="getProgressPercentage()"
        color="primary"
        class="h-2 rounded"
      />

      <div class="mt-4 text-center text-sm">
        مرحله {{ currentStep }} از {{ totalSteps }}
      </div>

      <!-- Step 1: General Information -->
      @if (currentStep === 1) {
        <h3 class="mb-6 text-lg font-semibold">
          اطلاعات عمومی حساب
        </h3>

        <form [formGroup]="generalInfoForm" class="space-y-6">
          <!-- Row 1: Code, Accounting Code 1, Accounting Code 2 -->
          <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>کد نوع حساب</mat-label>
              <input
                matInput
                formControlName="code"
                type="text"
                placeholder="کد نوع حساب"
              />
              @if (isFieldInvalid(generalInfoForm, 'code')) {
                <mat-error>
                  {{ getFieldError(generalInfoForm, 'code') }}
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>کد حسابداری ۱</mat-label>
              <input
                matInput
                formControlName="accountingCode1"
                type="text"
                placeholder="کد حسابداری ۱"
              />
              @if (isFieldInvalid(generalInfoForm, 'accountingCode1')) {
                <mat-error>
                  {{ getFieldError(generalInfoForm, 'accountingCode1') }}
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>کد حسابداری ۲</mat-label>
              <input
                matInput
                formControlName="accountingCode2"
                type="text"
                placeholder="کد حسابداری ۲"
              />
              @if (isFieldInvalid(generalInfoForm, 'accountingCode2')) {
                <mat-error>
                  {{ getFieldError(generalInfoForm, 'accountingCode2') }}
                </mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Row 2: Persian Name, English Name -->
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>نام فارسی نوع حساب</mat-label>
              <input
                matInput
                formControlName="nameFa"
                type="text"
                placeholder="مثال: حساب پرداختنی پذیرنده"
              />
              @if (isFieldInvalid(generalInfoForm, 'nameFa')) {
                <mat-error>
                  {{ getFieldError(generalInfoForm, 'nameFa') }}
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>نام انگلیسی</mat-label>
              <input
                matInput
                formControlName="nameEn"
                type="text"
                placeholder="Example: Merchant Payable Account"
              />
              @if (isFieldInvalid(generalInfoForm, 'nameEn')) {
                <mat-error>
                  {{ getFieldError(generalInfoForm, 'nameEn') }}
                </mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Row 3: Account Group, Subsystem -->
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>گروه حساب</mat-label>
              <mat-select formControlName="accountGroup">
                @for (group of accountGroups; track group.value) {
                  <mat-option [value]="group.value">
                    {{ group.label }}
                  </mat-option>
                }
              </mat-select>
              @if (isFieldInvalid(generalInfoForm, 'accountGroup')) {
                <mat-error>
                  {{ getFieldError(generalInfoForm, 'accountGroup') }}
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>زیرسیستم</mat-label>
              <mat-select formControlName="subsystem">
                @for (subsystem of subsystems; track subsystem.value) {
                  <mat-option [value]="subsystem.value">
                    {{ subsystem.label }}
                  </mat-option>
                }
              </mat-select>
              @if (isFieldInvalid(generalInfoForm, 'subsystem')) {
                <mat-error>
                  {{ getFieldError(generalInfoForm, 'subsystem') }}
                </mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Row 4: Product Type, Relation Type -->
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>نوع محصول</mat-label>
              <mat-select formControlName="productType">
                @for (product of productTypes; track product.value) {
                  <mat-option [value]="product.value">
                    {{ product.label }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>رابطه حسابداری با محصول</mat-label>
              <mat-select formControlName="relationType">
                @for (relation of relationTypes; track relation.value) {
                  <mat-option [value]="relation.value">
                    {{ relation.label }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Row 5: Party Type, Sub-account Type -->
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>نوع شخص</mat-label>
              <mat-select formControlName="partyType">
                @for (party of partyTypes; track party.value) {
                  <mat-option [value]="party.value">
                    {{ party.label }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>تعیین زیرحساب</mat-label>
              <mat-select formControlName="subAccountType">
                @for (subAccount of subAccountTypes; track subAccount.value) {
                  <mat-option [value]="subAccount.value">
                    {{ subAccount.label }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Row 6: Status, Description -->
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <div class="flex items-center space-x-3 space-x-reverse">
              <mat-slide-toggle
                formControlName="status"
                color="primary"
                class="mt-2"
              >
                <span class="text-sm font-medium">
                  {{ generalInfoForm.get('status')?.value ? 'فعال' : 'غیرفعال' }}
                </span>
              </mat-slide-toggle>
            </div>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>توضیحات</mat-label>
              <textarea
                matInput
                formControlName="description"
                rows="3"
                placeholder="توضیحات داخلی"
              ></textarea>
              @if (isFieldInvalid(generalInfoForm, 'description')) {
                <mat-error>
                  {{ getFieldError(generalInfoForm, 'description') }}
                </mat-error>
              }
            </mat-form-field>
          </div>
        </form>
      }

      <!-- Step 2: Allowed Currencies -->
      @if (currentStep === 2) {
        <h3 class="mb-6 text-lg font-semibold">
          تعریف ارزهای مجاز
        </h3>

        <form [formGroup]="currenciesForm" class="space-y-6">
          <!-- Currency Type Selection -->
          <div class="rounded-lg border p-4">
            <label class="mb-3 block text-sm font-medium">
              نوع ارز
            </label>
            <mat-radio-group
              formControlName="currencyType"
              class="flex flex-col space-y-2"
            >
              <mat-radio-button value="fixed" color="primary">
                ارز ثابت (فقط یک ارز)
              </mat-radio-button>
              <mat-radio-button value="multiple" color="primary">
                ارزهای مجاز (چند ارز)
              </mat-radio-button>
            </mat-radio-group>
          </div>

          <!-- Currency Selection -->
          <div class="rounded-lg border p-4">
            <label class="mb-3 block text-sm font-medium">
              انتخاب ارزها
              <span class="text-red-500">*</span>
            </label>
            <mat-chip-listbox
              class="flex flex-wrap gap-2"
              [multiple]="currenciesForm.get('currencyType')?.value === 'multiple'"
              (change)="onCurrencyChipChange($event)"
            >
              @for (currency of availableCurrencies; track currency.id) {
                <mat-chip-option
                  [value]="currency.id"
                  [selected]="isCurrencySelected(currency)"
                  color="primary"
                >
                  <span class="font-medium">{{ currency.nameFa }}</span>
                  <span class="text-xs opacity-75 mr-1">({{ currency.code }})</span>
                </mat-chip-option>
              }
            </mat-chip-listbox>
          </div>

          <!-- Default Currency -->
          @if (selectedCurrencies.length > 0 && currenciesForm.get('currencyType')?.value === 'multiple') {
            <div>
              <mat-form-field appearance="outline" class="w-full md:w-1/2">
                <mat-label>ارز پیش‌فرض</mat-label>
                <mat-select formControlName="defaultCurrency">
                  @for (currency of selectedCurrencies; track currency.id) {
                    <mat-option [value]="currency.id">
                      {{ currency.nameFa }} ({{ currency.code }})
                    </mat-option>
                  }
                </mat-select>
                @if (isFieldInvalid(currenciesForm, 'defaultCurrency')) {
                  <mat-error>
                    {{ getFieldError(currenciesForm, 'defaultCurrency') }}
                  </mat-error>
                }
              </mat-form-field>
            </div>
          }

          <!-- Selected Currencies Chips -->
          @if (selectedCurrencies.length > 0) {
            <div class="mt-4">
              <label class="mb-2 block text-sm font-medium">
                ارزهای انتخاب شده:
              </label>
              <div class="flex flex-wrap gap-2">
                <mat-chip-set>
                  @for (currency of selectedCurrencies; track currency.id) {
                    <mat-chip
                      [highlighted]="currenciesForm.get('defaultCurrency')?.value === currency.id"
                    >
                      {{ currency.nameFa }} ({{ currency.code }})
                      @if (currenciesForm.get('defaultCurrency')?.value === currency.id) {
                        <span class="mr-1 text-xs">
                          - پیش‌فرض
                        </span>
                      }
                    </mat-chip>
                  }
                </mat-chip-set>
              </div>
            </div>
          }
        </form>
      }

      <!-- Step 3: Allowed Organizational Units -->
      @if (currentStep === 3) {
        <h3 class="mb-6 text-lg font-semibold">
          تعریف واحدهای سازمانی مجاز
        </h3>

        <form [formGroup]="orgUnitsForm" class="space-y-6">
          <!-- Org Unit Type Selection -->
          <div class="rounded-lg border border-gray-200  p-4">
            <label class="mb-3 block text-sm font-medium">
              نوع انتخاب
            </label>
            <mat-radio-group
              formControlName="orgUnitType"
              class="flex flex-col space-y-2"
            >
              <mat-radio-button value="fixed" color="primary">
                واحد سازمانی ثابت (فقط یک واحد)
              </mat-radio-button>
              <mat-radio-button value="multiple" color="primary">
                واحدهای مجاز (چند واحد)
              </mat-radio-button>
            </mat-radio-group>
          </div>

          <!-- Org Unit Selection -->
          <div class="rounded-lg border p-4">
            <label class="mb-3 block text-sm font-medium">
              انتخاب واحدها
              <span class="text-red-500">*</span>
            </label>
            <mat-chip-listbox
              class="flex flex-wrap gap-2"
              [multiple]="orgUnitsForm.get('orgUnitType')?.value === 'multiple'"
              (change)="onOrgUnitChipChange($event)"
            >
              @for (unit of availableOrgUnits; track unit.id) {
                <mat-chip-option
                  [value]="unit.id"
                  [selected]="isOrgUnitSelected(unit)"
                  color="primary"
                >
                  <span class="font-medium">{{ unit.name }}</span>
                  <span class="text-xs opacity-75 mr-1">({{ unit.code }})</span>
                </mat-chip-option>
              }
            </mat-chip-listbox>
          </div>

          <!-- Default Org Unit -->
          @if (selectedOrgUnits.length > 0 && orgUnitsForm.get('orgUnitType')?.value === 'multiple') {
            <div>
              <mat-form-field appearance="outline" class="w-full md:w-1/2">
                <mat-label>واحد پیش‌فرض</mat-label>
                <mat-select formControlName="defaultOrgUnit">
                  @for (unit of selectedOrgUnits; track unit.id) {
                    <mat-option [value]="unit.id">
                      {{ unit.name }} ({{ unit.code }})
                    </mat-option>
                  }
                </mat-select>
                @if (isFieldInvalid(orgUnitsForm, 'defaultOrgUnit')) {
                  <mat-error>
                    {{ getFieldError(orgUnitsForm, 'defaultOrgUnit') }}
                  </mat-error>
                }
              </mat-form-field>
            </div>
          }

          <!-- Selected Org Units Chips -->
          @if (selectedOrgUnits.length > 0) {
            <div class="mt-4">
              <label class="mb-2 block text-sm font-medium">
                واحدهای انتخاب شده:
              </label>
              <div class="flex flex-wrap gap-2">
                <mat-chip-set>
                  @for (unit of selectedOrgUnits; track unit.id) {
                    <mat-chip
                      [highlighted]="orgUnitsForm.get('defaultOrgUnit')?.value === unit.id"
                    >
                      {{ unit.name }} ({{ unit.code }})
                      @if (orgUnitsForm.get('defaultOrgUnit')?.value === unit.id) {
                        <span class="mr-1 text-xs">
                          - پیش‌فرض
                        </span>
                      }
                    </mat-chip>
                  }
                </mat-chip-set>
              </div>
            </div>
          }
        </form>
      }

      <!-- Step 4: Limitations -->
      @if (currentStep === 4) {
        <h3 class="mb-6 text-lg font-semibold">
          تعریف محدودیت‌ها
        </h3>

        <form [formGroup]="limitationsForm" class="space-y-6">
          <!-- Add Limitation Form -->
          <div class="rounded-lg border border-gray-200 p-4">
            <h4 class="mb-4 text-sm font-semibold">
              افزودن محدودیت جدید
            </h4>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <!-- Limit Type -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>نوع محدودیت</mat-label>
                <mat-select formControlName="limitType">
                  @for (type of limitEntityTypes; track type.value) {
                    <mat-option [value]="type.value">
                      {{ type.label }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <!-- Relation Type -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>نوع رابطه</mat-label>
                <mat-select formControlName="relationType">
                  @for (relation of relationTypeOptions; track relation.value) {
                    <mat-option [value]="relation.value">
                      {{ relation.label }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <!-- Select Entities -->
            @if (limitationsForm.get('limitType')?.value) {
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>انتخاب موجودیت‌ها</mat-label>
                <mat-select formControlName="selectedEntityIds" multiple>
                  @for (entity of getEntitiesForLimitType(limitationsForm.get('limitType')?.value); track entity.id) {
                    <mat-option [value]="entity.id">
                      {{ entity.name }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            }

            <!-- Description -->
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>توضیحات</mat-label>
              <textarea
                matInput
                formControlName="limitDescription"
                rows="2"
                placeholder="توضیح در مورد محدودیت خاص"
              ></textarea>
            </mat-form-field>

            <!-- Add Button -->
            <div class="flex justify-end">
              <button
                mat-raised-button
                type="button"
                color="primary"
                (click)="addLimitation()"
                class="px-6"
              >
                افزودن محدودیت
              </button>
            </div>
          </div>

          <!-- Limitations List -->
          @if (limitations.length > 0) {
            <div class="mt-6">
              <h4 class="mb-4 text-sm font-semibold">
                لیست محدودیت‌ها
              </h4>
              <div class="space-y-3">
                @for (limitation of limitations; track limitation.id) {
                  <div class="rounded-lg border p-4 shadow-sm">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="mb-2 flex items-center gap-3">
                          <span class="rounded  px-3 py-1 text-sm font-medium text-blue-800">
                            {{ limitation.limitTypeName }}
                          </span>
                          <span
                            class="rounded px-3 py-1 text-sm font-medium"
                            [class.bg-green-100]="limitation.relationType === 'allowed'"
                            [class.text-green-800]="limitation.relationType === 'allowed'"
                            [class.bg-red-100]="limitation.relationType === 'not-allowed'"
                            [class.text-red-800]="limitation.relationType === 'not-allowed'"
                          >
                            {{ limitation.relationTypeName }}
                          </span>
                        </div>
                        <div class="mb-2 text-sm">
                          <strong>موجودیت‌ها:</strong>
                          {{ limitation.entities }}
                        </div>
                        @if (limitation.description) {
                          <div class="text-sm">
                            {{ limitation.description }}
                          </div>
                        }
                      </div>
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="removeLimitation(limitation.id)"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          @if (limitations.length === 0) {
            <div class="rounded-lg border-2 border-dashed border-gray-300 p-8 text-center">
              <mat-icon class="mb-2" style="font-size: 48px; width: 48px; height: 48px;">
                rule
              </mat-icon>
              <p class="text-sm">
                هیچ محدودیتی تعریف نشده است. از فرم بالا محدودیت‌های مورد نظر را اضافه کنید.
              </p>
            </div>
          }
        </form>
      }

      <div class="mt-8 flex justify-between">
        <button
          mat-stroked-button
          type="button"
          (click)="goBack()"
          class="px-8"
        >
          انصراف
        </button>

        <div class="flex space-x-4 space-x-reverse">
          @if (currentStep > 1) {
            <button
              mat-stroked-button
              (click)="previousStep()"
              class="px-8"
            >
              قبلی
            </button>
          }
          @if (currentStep < totalSteps) {
            <button
              mat-raised-button
              color="primary"
              (click)="nextStep()"
              class="px-8"
            >
              بعدی
            </button>
          }
          @if (currentStep === totalSteps) {
            <button
              mat-raised-button
              color="primary"
              (click)="onSubmit()"
              class="px-8"
            >
              ذخیره نهایی
            </button>
          }
        </div>
      </div>
    </div>
  </div>
</div>
